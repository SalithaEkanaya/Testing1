package bonotel.setup;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;
import org.apache.struts.action.ActionMessage;
import org.apache.struts.action.ActionMessages;

import rez.services.connectorservices.RezService;
import rez.services.connectorservices.ServiceData;
import rez.services.connectorservices.ServiceObjectFactory;
import rezg.utils.CommonUtils;
import rezg.utils.TagLibUtils;
import bonotel.common.BaseAction;
import bonotel.server.setup.BlackoutGroup;
import bonotel.server.setup.RateRegion;

/*

 *  BonotelWebApp / BlackoutGroupSetupAction.java

 *  @author  lakmali

 *  date    Aug 11, 2006

 *  notes

 *    [Description about BlackoutGroupSetupAction.java ]

 *  version 

 *     1.0

 *  Revision 

 *     [History of the file modification] 

 *     User                                  Date                 Modification

 *      

 */

public class BlackoutGroupSetupAction extends BaseAction{


	public ActionForward executeTask(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {

		ActionForward af = null;
		ActionMessages messages = new ActionMessages();

		try {
			String errorMessage = null;
			String errorCode = null;
			
			HttpSession session = request.getSession();
			boolean dataUpdated = false;
			String myFormActionType = null;

			String event = TagLibUtils.getInstance().determineEvent(request);
			myFormActionType = request.getParameter("ActionType");
			
			System.out.println("blackout group > Action > "+myFormActionType);
			
			if (myFormActionType==null || myFormActionType.equals("resetFormData")) {
				myFormActionType="default";
			    session.removeAttribute("BlackoutGroupSetupForm");
			    BlackoutGroupSetupForm myblackoutGroupSetupForm = (BlackoutGroupSetupForm) form;
				String myReloadScreenAction = request.getParameter("screenaction");
                if (myReloadScreenAction!=null) {
                	myblackoutGroupSetupForm.setScreenaction(myReloadScreenAction); 	
                }
			    session.setAttribute("BlackoutGroupSetupForm",myblackoutGroupSetupForm);
			    af = mapping.findForward("displaypage");
			    return af;
			} else if (myFormActionType.equals("reloadFormWithData")) {
			    af = mapping.findForward("displaypage");
			    return af;
			} else if(myFormActionType.equals("submit")) {
				
				BlackoutGroupSetupForm myblackoutGroupSetupForm = (BlackoutGroupSetupForm) form;
				System.out.println("get connection");
				String myServiceIP = (String)session.getAttribute("serviceip");
	    		String myServicePort = (String)session.getAttribute("serviceport");
				RezService service = ServiceObjectFactory.getService(myServiceIP,myServicePort);
				System.out.println("get connected");
				System.out.println("myServiceIP "+myServiceIP);
				System.out.println("myServicePort "+myServicePort);
				
				//populate Service data
			
				BlackoutGroup blackoutgrp = new BlackoutGroup();
				blackoutgrp.setBlackoutGroupName(myblackoutGroupSetupForm.getBlackoutGroupName());
	            
	            
	            if(!myblackoutGroupSetupForm.getScreenaction().equals("create")){
	            	System.out.println("ID >>>> "+myblackoutGroupSetupForm.getGroupId());
	            	if(myblackoutGroupSetupForm.getGroupId()==null || myblackoutGroupSetupForm.getGroupId().equals("")){
						errorMessage = "errors.regionsetup.notselect.error";
						messages.add(ActionMessages.GLOBAL_MESSAGE, new ActionMessage(errorMessage));
						saveErrors(request, messages);
						af = mapping.findForward("error");
						return af;
	            	}
	            	blackoutgrp.setId(new Integer(myblackoutGroupSetupForm.getGroupId()));
				}
	            
	            if (myblackoutGroupSetupForm.getScreenaction().equals("delete")) {
	    			System.out.println("Status = 'N' ");
	    			blackoutgrp.setStatus("N");
	    		}else{
	    			System.out.println("Status = 'Y' ");
	    			blackoutgrp.setStatus("Y");
	    		}
	            
	            System.out.println("Screenaction "+myblackoutGroupSetupForm.getScreenaction());
				
				ServiceData serviceData = new ServiceData();
				System.out.println("test 01");
				serviceData.setServiceName(CommonUtils.getInstance().getPortalName(request)+"BlackoutGroupSetup");
				System.out.println("test 02");
				serviceData.setActionMethod(myblackoutGroupSetupForm.getScreenaction());
				System.out.println("test 03");
				serviceData.setInputData(blackoutgrp);
				System.out.println("test 04");
				serviceData.setInputData(CommonUtils.getInstance().getPortalName(request));
				System.out.println("test 05");
				
				System.out.println("executeService");
				serviceData = service.executeService(serviceData);
				System.out.println("executed");
				Boolean dataUpdateRes = (Boolean) (serviceData.getOutputData(0));
				errorCode = (String) (serviceData.getOutputData(1));
				dataUpdated = dataUpdateRes.booleanValue();
				
				try{
					System.out.println("ErrorCode > "+serviceData.getOutputData(1));
				}catch(Exception e){System.out.println("error"+e.toString());}

				System.out.println("dataUpdated "+dataUpdated);
			} else {
				dataUpdated=true;	
			}
			
			if (dataUpdated) {
				session.setAttribute("savedmsg","msg.saved.success");
				af = mapping.findForward("success");
				return af;
			} else {
				/*if (errorCode.equals("NON-UNIQUE-REGIONSETUPNAME")){
					errorMessage = "errors.regionsetup.data.save.unique.error";
				}else{
					errorMessage = "errors.general";
				}
				*/
				messages.add(ActionMessages.GLOBAL_MESSAGE, new ActionMessage(errorMessage));
				saveErrors(request, messages);
				af = mapping.findForward("error");
				return af;
			}

		} catch (Exception e) {

			e.printStackTrace();
			messages.add(ActionMessages.GLOBAL_MESSAGE, new ActionMessage("errors.general"));
			saveErrors(request, messages);
			af = mapping.findForward("error");
			return af;
		}
	}



}



